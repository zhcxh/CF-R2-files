<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>R2 æ–‡ä»¶æœåŠ¡å™¨ï¼ˆå¸¦ Tokenï¼‰</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}
    .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2.5rem;margin-bottom:10px}
    .content{padding:30px}
    .upload-section{background:#f8f9fa;border-radius:15px;padding:25px;margin-bottom:30px}
    #uploadArea{border:3px dashed #667eea;border-radius:10px;padding:40px;text-align:center;cursor:pointer;transition:.3s}
    #uploadArea.dragover{border-color:#764ba2;background:#f0f4ff}
    #uploadArea:hover{border-color:#764ba2;background:#f8f9ff}
    #fileInput{display:none}
    .btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:10px 20px;border-radius:25px;cursor:pointer;margin:5px;transition:.3s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    .btn-danger{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a24 100%)}
    .file-item{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;border-bottom:1px solid #eee}
    .file-item:hover{background:#f8f9fa}
    .file-info{display:flex;align-items:center;gap:15px;flex:1}
    .file-name{font-weight:500}
    .file-size{font-size:.85rem;color:#666}
    .progress{width:100%;height:4px;background:#eee;border-radius:2px;overflow:hidden;margin-top:10px}
    .progress-bar{height:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);width:0;transition:.3s}
    .message{padding:15px 20px;border-radius:10px;margin-bottom:20px;display:none}
    .message.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .message.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
  </style>
</head>
<body>
<div class="container">
  <div class="header"><h1>ğŸ“ R2 æ–‡ä»¶æœåŠ¡å™¨</h1><p>å¸¦ Token è®¤è¯ï¼Œæ”¯æŒä¸Šä¼ /ä¸‹è½½/åˆ é™¤</p></div>
  <div class="content">
    <div id="msg" class="message"></div>
<!-- ===== ä¸€é”®ç”Ÿæˆå™¨ ===== -->
<div style="background:#f5f7fa;border:1px solid #e0e0e0;border-radius:8px;padding:20px;margin-bottom:20px">
  <h3 style="margin:0 0 12px 0">ä¸€é”®ç”Ÿæˆä¸Šä¼ å·¥å…·</h3>
  <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
    <span style="font-weight:500">åŸŸåï¼š</span>
    <input id="genDomain" type="text" readonly style="flex:1;min-width:220px;padding:8px 10px;border:1px solid #ccd0d5;border-radius:4px;background:#f4f4f4">
    <span style="font-weight:500">TOKENï¼š</span>
    <input id="genToken"  type="text" readonly style="flex:1;min-width:160px;padding:8px 10px;border:1px solid #ccd0d5;border-radius:4px;background:#f4f4f4">
    <button id="genBtn" class="btn" style="margin:0">ç”Ÿæˆ upload.bat</button>
  </div>
  <div id="genMsg" style="margin-top:10px;font-size:13px;display:none"></div>
</div>
    <div class="upload-section">
      <h2 style="margin-bottom:20px">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h2>
      <div id="uploadArea">
        <div class="upload-icon">â˜ï¸</div>
        <h3>æ‹–æ‹½æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</h3>
        <p style="color:#666;margin-top:10px">å•æ–‡ä»¶æœ€å¤§ 100 MB</p>
        <input id="fileInput" type="file" multiple>
      </div>
      <div id="upProgress" class="progress" style="display:none">
        <div id="upBar" class="progress-bar"></div>
      </div>
    </div>
    <div>
      <h2 style="margin-bottom:15px">ğŸ“‹ æ–‡ä»¶åˆ—è¡¨</h2>
      <div id="fileList"></div>
    </div>
  </div>
</div>

<script>
/* å…¨å±€æå‰æ‹¦æˆªæµè§ˆå™¨é»˜è®¤æ‹–æ”¾ */
window.addEventListener('dragover', e => e.preventDefault());
window.addEventListener('drop', e => e.preventDefault());

window.addEventListener('DOMContentLoaded', () => {
  const API = location.origin + location.pathname.replace(/\/$/, '');
  const TOKEN = new URLSearchParams(location.search).get('token') || localStorage.getItem('r2token') || '';
  if (!TOKEN) { alert('è¯·å…ˆåœ¨æœ¬ URL å¸¦ä¸Š ?token=****** å†è®¿é—®'); throw new Error('no token'); }
  localStorage.setItem('r2token', TOKEN);

  function qs(o) { return new URLSearchParams({ ...o, token: TOKEN }).toString(); }
  function msg(txt, err) {
    const m = document.getElementById('msg');
    m.textContent = txt; m.className = 'message ' + (err ? 'error' : 'success');
    m.style.display = 'block'; setTimeout(() => m.style.display = 'none', 4000);
  }

  /* ========== äº‹ä»¶å§”æ‰˜ï¼šç›´è¿ / ä¸‹è½½ / åˆ é™¤ ========== */
  document.addEventListener('click', e => {
    if (e.target.classList.contains('btn-link')) {
      e.stopPropagation();
      const filename = e.target.dataset.name;
      if (filename) copyDirectLink(filename);
    }
    if (e.target.classList.contains('btn-download')) {
      e.stopPropagation();
      const filename = e.target.dataset.name;
      if (filename) downloadFile(filename);
    }
    if (e.target.classList.contains('btn-delete')) {
      e.stopPropagation();
      const filename = e.target.dataset.name;
      if (filename) deleteFile(filename);
    }
  });

  /* ========== ä¸Šä¼ åŒºåŸŸç»‘å®š ========== */
  const fileInput = document.getElementById('fileInput');
  const upArea    = document.getElementById('uploadArea');
  const upBar     = document.getElementById('upBar');
  const upBox     = document.getElementById('upProgress');

  upArea.onclick = () => fileInput.click();
  upArea.addEventListener('dragover', e => { e.preventDefault(); upArea.classList.add('dragover'); });
  upArea.addEventListener('dragleave', e => { e.preventDefault(); upArea.classList.remove('dragover'); });
  upArea.addEventListener('drop', e => {
    e.preventDefault(); upArea.classList.remove('dragover');
    const files = [...e.dataTransfer.files];
    if (files.length) uploadFiles(files);
  });
  fileInput.onchange = e => uploadFiles([...e.target.files]);

  /* ========== ä¸Šä¼ å®ç° ========== */
  async function uploadFiles(files) {
    upBox.style.display = 'block';
    for (const f of files) {
      await new Promise(resolve => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', API + '/upload?' + qs({}));
        xhr.upload.onprogress = e => { if (e.lengthComputable) upBar.style.width = (e.loaded / e.total * 100) + '%'; };
        xhr.onload = () => {
          upBar.style.width = '0';
          if (xhr.status === 200) { msg('ä¸Šä¼ æˆåŠŸ'); loadList(); } else msg('ä¸Šä¼ å¤±è´¥', 1);
          resolve();
        };
        xhr.onerror = () => { msg('ç½‘ç»œé”™è¯¯', 1); resolve(); };
        const fd = new FormData(); fd.append('file', f); xhr.send(fd);
      });
    }
    upBox.style.display = 'none';
  }

  /* ========== åˆ—è¡¨ / å·¥å…·å‡½æ•° ========== */
  async function loadList() {
    const r = await fetch(API + '/files?' + qs({})).then(r => r.json()).catch(() => null);
    if (!r) return msg('è¯»å–åˆ—è¡¨å¤±è´¥', 1);
    document.getElementById('fileList').innerHTML = r.map(o => `
      <div class="file-item">
        <div class="file-info">
          <span style="font-size:1.5rem">${o.icon || 'ğŸ“'}</span>
          <div>
            <div class="file-name">${o.name}</div>
            <div class="file-size">${fmt(o.size)} Â· ${new Date(o.uploadedAt).toLocaleString()}</div>
          </div>
        </div>
        <div class="file-actions">
          <!-- ç›´è¿æ’åœ¨æœ€å‰ -->
          <button class="btn btn-link" data-name="${encodeURIComponent(o.name)}">ç›´è¿</button>
          <button class="btn btn-download" data-name="${encodeURIComponent(o.name)}">ä¸‹è½½</button>
          <button class="btn btn-danger btn-delete" data-name="${encodeURIComponent(o.name)}">åˆ é™¤</button>
        </div>
      </div>`).join('') || '<div style="padding:40px;text-align:center;color:#666">æš‚æ— æ–‡ä»¶</div>';
  }

  function fmt(b) {
    const s = ['B', 'KB', 'MB', 'GB']; let i = 0;
    while (b > 1024 && i < 3) { b /= 1024; i++; }
    return b.toFixed(2) + ' ' + s[i];
  }

  async function downloadFile(n) {
    const a = document.createElement('a');
    a.href = API + '/files/' + n + '?' + qs({});
    a.download = decodeURIComponent(n);
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  async function deleteFile(n) {
    if (!confirm('ç¡®è®¤åˆ é™¤ ' + decodeURIComponent(n) + ' ?')) return;
    const r = await fetch(API + '/files/' + n + '?' + qs({}), { method: 'DELETE' }).then(r => r.json()).catch(() => null);
    r ? msg('åˆ é™¤æˆåŠŸ') : msg('åˆ é™¤å¤±è´¥', 1); loadList();
  }

  async function copyDirectLink(n) {
    const url = API + '/files/' + n + '?' + qs({});
    try {
      await navigator.clipboard.writeText(url);
      msg('ç›´è¿å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (err) {
      const ta = document.createElement('textarea');
      ta.value = url; ta.style.position = 'fixed'; ta.style.opacity = 0;
      document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      msg('ç›´è¿å·²å¤åˆ¶ï¼ˆé™çº§æ–¹æ¡ˆï¼‰');
    }
  }

  /* ========== åˆå§‹åŠ è½½ ========== */
  loadList();
});
</script>
<!-- å¼•å…¥ JSZip -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
/* ===== ä¸€é”®ç”Ÿæˆå™¨ ===== */
(() => {
  // è‡ªåŠ¨è§£æåŸŸå & token
  const u = new URL(location.href);
  const domain = u.origin + u.pathname.replace(/\/$/,'');
  const token  = u.searchParams.get('token') || '';

  const $  = id => document.getElementById(id);
  const $d = $('genDomain');
  const $t = $('genToken');
  const $b = $('genBtn');
  const $m = $('genMsg');

  $d.value = domain;
  $t.value = token;

  $b.addEventListener('click', async () => {
    if (!token) { $m.textContent='åœ°å€æ ç¼ºå°‘ tokenï¼';$m.style.color='red';$m.style.display='block'; return; }

    const bat = `@echo off
chcp 65001 > nul
:: ==================  R2 ä¸€é”®ä¸Šä¼   ==================
:: æ‹–æ–‡ä»¶åˆ°å›¾æ ‡å³å¯ä¸Šä¼ ï¼ˆå·²å¡«å¥½åœ°å€ & Tokenï¼‰

set "FILE=%~1"
if "%%FILE%%"=="" (
    echo ç”¨æ³•ï¼šç›´æ¥æŠŠæ–‡ä»¶æ‹–åˆ°æœ¬å›¾æ ‡ä¸Š
    pause & exit /b 1
)
if not exist "%%FILE%%" (
    echo æ–‡ä»¶ä¸å­˜åœ¨ï¼š%%FILE%%
    pause & exit /b 1
)
echo æ­£åœ¨ä¸Šä¼ ï¼š%%~nx1 ...
curl -X POST -F "file=@\"%%FILE%%\"" "${domain}/upload?token=${token}"
echo.
echo ä¸Šä¼ å®Œæˆï¼
pause`;

    const zip = new JSZip();
    zip.file('upload.bat', bat);
    const blob = await zip.generateAsync({type:'blob'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = 'upload.zip';
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    $m.textContent='ç”ŸæˆæˆåŠŸï¼å·²è‡ªåŠ¨ä¸‹è½½ upload.zipï¼ˆå†…å«å·²å¡«å¥½å‚æ•°çš„ upload.batï¼‰';$m.style.color='green';$m.style.display='block';
  });
})();
</script>
</body>
</html>
